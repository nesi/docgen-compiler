
for file in ${NESIDOC_AUTOMATIC_MODULELISTS_DIR}/* ${NESIDOC_SUPPLEMENTARY_MODULELISTS_DIR}/*
do
	# Get a machine name (the file name minus the extension)
	basefile=$(basename $file)
	machine=${basefile%.*}
	linecount=0
	while read line
	do
		$((linecount++))
		module=$(echo $line | cut -d':' -f 1 | \
			sed -e 's/^\s\+//' | sed -e 's/\s\+$//')
		description=$(echo $line | cut -d':' -f 2- | \
			sed -e 's/^\s\+//' | sed -e 's/\s\+$//')
		packagename=$(echo $module | cut -d'/' -f 1 | \
			sed -e 's/^\s\+//' | sed -e 's/\s\+$//')
		version=$(echo $module | cut -d'/' -f 2- | \
			sed -e 's/^\s\+//' | sed -e 's/\s\+$//')

		if [ -z "${module}" ]
		then
			echo "$file: no module found on line $linecount"
			continue
		elif [ -z "${packagename}" ]
		then
			echo "$file: no package name identified on line $linecount"
			continue
		elif [ -z "${version}" ]
		then
			echo "$file: no version identified on line $linecount"
			continue
		elif [ -z "${description}" ]
		then
			echo "$file: no package description found on line $linecount"
		fi

		tempversionfile="${tmpdir}/versions/${packagename}.html"
		if [ ! -e "${tempversionfile}" ]
		then
			echo "<table>" > ${tempversionfile}
			echo "  <tr>" >> ${tempversionfile}
			echo "    <th>Module</th>" >> ${tempversionfile}
			echo "    <th>NeSI Cluster</th>" >> ${tempversionfile}
			echo "  </tr>" >> ${tempversionfile}
		fi
		echo "  <tr>" >> ${tempversionfile}
		echo "    <td>${module}</td>" >> ${tempversionfile}
		echo "    <td>${machine}</td>" >> ${tempversionfile}
		echo "  </tr>" >> ${tempversionfile}

		tempblurbfile="${tmpdir}/blurbs/${packagename}.md"
		echo "## ${module} on ${machine}" >> ${tempblurbfile}
		echo "" >> ${tempblurbfile}
		(echo "${description}" | fold -w 80 -s) >> ${tempblurbfile}
	done < <(sort -u -k1,1 -t ':' $file)
done

for tempversionfile in ${tmpdir}/versions/*
do
	basefile=$(basename $tempversionfile)
	packagename=${basefile%.*}
	echo "</table>" >> ${tempversionfile}
	permversionfile=${NESIDOC_VERSIONS_DIR}/${packagename}.html
	if [ ! -e "${permversionfile}" ]
	then
		echo "Creating a new table of available versions for ${packagename}"
	else
		diff ${tempversionfile} ${permversionfile}
		diffstatus=$?
		if [ ${diffstatus} -eq 2 ]
		then
			echo "$progname: error: comparison of ${tempversionfile} and ${permversionfile} failed"
			continue
		elif [ ${diffstatus} -eq 1 ]
		then
			echo "Available versions of ${packagename} have changed and will be updated."
		fi
	fi
	mv ${tempversionfile} ${permversionfile}
done

for tempblurbfile in ${tmpdir}/blurbs/*
do
	basefile=$(basename $tempblurbfile)
	packagename=${basefile%.*}
	perminfofile=${NESIDOC_INFO_DIR}/${packagename}.md
	if [ ! -e ${perminfofile} ]
	then
		echo "Creating a new information file for $packagename"
		awk -v f="${tempblurbfile}" 'BEGIN {while (getline < f) txt=txt $0 "\n"} /<!--This is a placeholder for a description. Do not edit.-->/ {sub("<!--This is a placeholder for a description. Do not edit.-->", txt)} 1' ${template} > ${perminfofile}
	fi
done
